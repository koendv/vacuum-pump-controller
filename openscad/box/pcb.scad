// This file contains the coordinates of the pcb pins. 
// The pin coordinates were determined like this:

// Open the pcb in easyeda. Set units to mm.
// Generate Gerbers.  
// Join the files Gerber_Drill_NPTH.DRL and Gerber_Drill_PTH.DRL.
// The header will look similar to this:
//
// METRIC,LZ,000.000

// Edit the Gerber file:
// replace X with [
// replace Y with ,
// replace eol with ],
// replace G85 with ],
// So a line like this
// X045705Y048914
// becomes this:
// [045705,048914],
// and paste the result in this openscad script.

// pins1 is the pin coordinates, as found in the gerber files
pins1 = [
  [045705,048914],
  [045644,055932],
  [038100,099060],
  [038100,096520],
  [038100,093980],
  [038100,091440],
  [038100,088900],
  [038100,086360],
  [038100,083820],
  [038100,081280],
  [038100,078740],
  [038100,076200],
  [038100,073660],
  [038100,071120],
  [038100,068580],
  [038100,066040],
  [038100,063500],
  [038100,060960],
  [038100,058420],
  [038100,055880],
  [038100,053340],
  [038100,050800],
  [053340,099060],
  [053340,096520],
  [053340,093980],
  [053340,091440],
  [053340,088900],
  [053340,086360],
  [053340,083820],
  [053340,081280],
  [053340,078740],
  [053340,076200],
  [053340,073660],
  [053340,071120],
  [053340,068580],
  [053340,066040],
  [053340,063500],
  [053340,060960],
  [053340,058420],
  [053340,055880],
  [053340,053340],
  [053340,050800],
  [010160,088900],
  [010160,086360],
  [017145,099060],
  [019685,099060],
  [022225,099060],
  [024765,099060],
  [027305,099060],
  [029845,099060],
  [017145,083820],
  [019685,083820],
  [022225,083820],
  [024765,083820],
  [027305,083820],
  [029845,083820],
  [017145,088900],
  [019685,088900],
  [022225,088900],
  [024765,088900],
  [027305,088900],
  [029845,088900],
  [017145,093980],
  [019685,093980],
  [022225,093980],
  [024765,093980],
  [027305,093980],
  [029845,093980],
  [010160,073660],
  [010160,071120],
  [010160,068580],
  [010160,066040],
  [010160,063500],
  [010160,060960],
  [010160,058420],
  [010160,055880],
  [043515,058230],[043515,057330],
  [047925,059229],[047925,058329],
  [043515,054230],[043515,053330],
  [043515,050891],[043515,049991],
  [059690,069850],
  [059690,072390],
  [059690,074930],
  [059690,077470],
  [059690,080010],
  [059690,082550],
  [059690,085090],
  [020320,073660],
  [025400,073660],
  [010160,083820],
  [030480,073660],
  [030480,071120],
  [030480,068580],
  [030480,066040],
  [030480,063500],
  [030480,060960],
  [030480,058420],
  [030480,055880],
  [015240,055880],
  [015240,058420],
  [015240,060960],
  [015240,063500],
  [015240,066040],
  [015240,068580],
  [015240,071120],
  [015240,073660],
  [023465,050975],[021265,050975],
  [023465,056975],[021265,056975],
  [027165,055575],[027165,053375],
  [012000,051000],
  [012000,098000],
  [059000,098000],
  [059000,051000],
];
  
// following coordinates have been extracted from pins1[]:

pins_screws = [  
  [012000,051000],
  [012000,098000],
  [059000,098000],
  [059000,051000],
];

pins_stm32 = [
//  [045705,048914],
//  [045644,055932],
//  [038100,099060],
  [038100,096520],
  [038100,093980],
  [038100,091440],
  [038100,088900],
  [038100,086360],
  [038100,083820],
  [038100,081280],
  [038100,078740],
//  [038100,076200],
//  [038100,073660],
//  [038100,071120],
//  [038100,068580],
//  [038100,066040],
//  [038100,063500],
//  [038100,060960],
//  [038100,058420],
//  [038100,055880],
//  [038100,053340],
//  [038100,050800],
//  [053340,099060],
  [053340,096520],
  [053340,093980],
  [053340,091440],
  [053340,088900],
  [053340,086360],
  [053340,083820],
  [053340,081280],
  [053340,078740],
//  [053340,076200],
//  [053340,073660],
//  [053340,071120],
//  [053340,068580],
//  [053340,066040],
//  [053340,063500],
//  [053340,060960],
//  [053340,058420],
//  [053340,055880],
//  [053340,053340],
//  [053340,050800],
];

pins_sensors = [
//  [017145,099060],
//  [019685,099060],
//  [022225,099060],
//  [024765,099060],
//  [027305,099060],
//  [029845,099060],
  [017145,083820],
  [019685,083820],
  [022225,083820],
  [024765,083820],
  [027305,083820],
  [029845,083820],
  [017145,088900],
  [019685,088900],
  [022225,088900],
  [024765,088900],
  [027305,088900],
  [029845,088900],
  [017145,093980],
  [019685,093980],
  [022225,093980],
  [024765,093980],
  [027305,093980],
  [029845,093980],
  ];
  
pins_serial = [
  [010160,088900],
  [010160,086360],
  [010160,083820],
  ];

pins_motor = [  
  [010160,073660],
  [010160,071120],
  [010160,068580],
  [010160,066040],
  [010160,063500],
  [010160,060960],
  [010160,058420],
  [010160,055880],
  ];

// pin3 of the oled - the pin in the middle
pin3_oled = [059690,077470];
oled_x = 21.744;
oled_y = 10.864;

pcb_x = 55.0;
pcb_y = 55.0;
pcb_offset_x = (55.0-47.0)/2;
pcb_offset_y = (55.0-47.0)/2;

$fn = $preview?16:64;
inch = 25.4;
nozzle_width = 0.4;
eps = 0.001;
eps2 = 2*eps;

module pin(x,dia) {
    translate(x)
    cylinder(h=1, d=dia);
}

module dupont_pin(x) {
    translate(x)
    square([inch/10, inch/10], center=true);
}

module dupont_connector(xarray) {
    corner=pins_screws[0];
    offset(nozzle_width)
    hull()
    for (p1 = xarray) {
        p1=(p1-corner)/1000;
        dupont_pin(p1);
    }
}

module pcb_allholes() {
    corner=pins_screws[0];
    for (p1 = pins1) {
        p1=(p1-corner)/1000;
        translate(p1)
        circle(d=1);
    }
}

module screw_holes() {
    corner=pins_screws[0];
    for (p1 = pins_screws) {
        p1=(p1-corner)/1000;
        translate(p1)
        circle(d=3.2);
    }
}
module stm32_button_and_jumpers() {
    offset(inch/10)
    offset(-2*inch/10)
    hull()
    dupont_connector(pins_stm32);
}

module oled_screen() {
    corner = pins_screws[0];
    pin3 = (pin3_oled-corner) / 1000;
    translate(pin3)
    translate([3.0, -oled_x/2])
    offset(1.0)
    square([oled_y, oled_x]);
}

module pcb_top_holes() {
    dupont_connector(pins_serial);
    dupont_connector(pins_motor);
    dupont_connector(pins_sensors);
    stm32_button_and_jumpers();
    oled_screen();
    //screw_holes();
}

module pcb_bottom_holes() {
    screw_holes();
}

module pcb_board() {
    translate([-pcb_offset_x, -pcb_offset_y])
    square([pcb_x, pcb_y]);
}

module pcb() {
    color("Black")
    translate([0, 0, 2*eps])
    pcb_allholes();
    color("Red")
    translate([0, 0, eps])
    pcb_top_holes();
    color("Blue")
    translate([0, 0, eps])
    pcb_bottom_holes();
    color("Green")
    pcb_board();
}


//pcb();

// not truncated
